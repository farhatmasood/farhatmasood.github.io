<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recovery Calculation Software</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        select, input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%236b7280' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9' /%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; background-image: none; padding-right: 0.75rem; }
        
        #tooltip {
            position: absolute;
            display: none;
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        #recoveryScene {
            cursor: grab;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
        }
        #recoveryScene:active {
            cursor: grabbing;
        }

        .winch-line {
            stroke-dasharray: 5 5;
            animation: winch 2s linear infinite;
        }
        @keyframes winch {
            to { stroke-dashoffset: -20; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl overflow-hidden">
        <header class="bg-gray-800 text-white p-4 flex flex-col sm:flex-row justify-between items-center gap-2">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400" viewBox="0 0 24 24" fill="currentColor"><path d="M21.9 12.6L20.3 6.8C20.1 6 19.3 5.5 18.5 5.5H15V4c0-.6-.4-1-1-1H3c-.6 0-1 .4-1 1v1H1c-.6 0-1 .4-1 1v4c0 .6.4 1 1 1h1v2H1c-.6 0-1 .4-1 1v4c0 .6.4 1 1 1h1v1c0 .6.4 1 1 1h11c.6 0 1-.4 1-1v-2h3.5c.8 0 1.6-.5 1.8-1.3l1.6-5.8c.2-.7-.1-1.5-.9-1.7zM13 18H4v-2h9v2zm0-4H4v-2h9v2zm0-4H4V8h9v2zM6 5h7v1H6V5zm10.7 7.2l-1.6 5.8c-.1.3-.3.5-.6.5h-2.5V7.5h3.5c.3 0 .5.2.6.5l1.6 5.8c.1.3 0 .7-.3.8zM22 10.5c-.6 0-1 .4-1 1s.4 1 1 1 .9-.4.9-1-.4-1-1-1zm-4.5-1.5c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1z"/></svg>
                <h1 class="text-lg sm:text-xl font-bold">Recovery Calculation Software</h1>
            </div>
            <div class="flex space-x-2">
                <button id="appliancesBtn" class="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-md transition-colors">Appliances</button>
                <button id="aboutBtn" class="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-md transition-colors">About</button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column: Inputs -->
                <div class="lg:col-span-2 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Inputs</h2>
                     <div>
                        <label for="casualty" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="The weight of the vehicle that is stuck and needs recovery.">Type of Casualty (Tons)</label>
                        <select id="casualty" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="0" data-type="none" disabled selected>Please select</option>
                            <option value="1" data-type="jeep">Jeeps</option>
                            <option value="3" data-type="truck">3/4 Ton Vehicles</option>
                            <option value="6" data-type="truck">2-1/2 Ton Vehicles</option>
                            <option value="18" data-type="truck">5 Ton Recovery Vehicles</option>
                            <option value="48" data-type="tank">Tank M-48A5</option>
                            <option value="36" data-type="tank">Tank T-59M</option>
                            <option value="36.7" data-type="tank">Tank T-69IIM</option>
                            <option value="44" data-type="tank">Tank T-85IIAP</option>
                            <option value="46" data-type="tank">Tank T-80 UD</option>
                            <option value="52" data-type="tank">Tank Centurion</option>
                            <option value="46" data-type="tank">SP M-109A2/M 110A2</option>
                            <option value="other" data-type="truck">Other</option>
                        </select>
                        <input type="number" id="otherCasualty" placeholder="Enter tons" class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="recoveryVeh" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="The available pulling force of the vehicle performing the recovery.">Recovery Vehicle Pull (Tons)</label>
                        <select id="recoveryVeh" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="0" data-type="none" disabled selected>Please select</option>
                            <option value="22.5" data-type="truck">Truck Wrecker M-816</option>
                            <option value="25" data-type="truck">Tatra AV-8</option>
                            <option value="6" data-type="truck">Truck Wrecker FIAT 90.17WM</option>
                            <option value="45" data-type="tank">ARV M-88A1</option>
                            <option value="35" data-type="tank">ARV W-653</option>
                            <option value="22.5" data-type="tank">Towing Tractor T-59</option>
                            <option value="5" data-type="truck">2-1/2 Ton Vehicle</option>
                            <option value="7.5" data-type="truck">Truck Wrecker IVECO 140E24W</option>
                            <option value="other" data-type="truck">Other</option>
                        </select>
                         <input type="number" id="otherRecovery" placeholder="Enter tons" class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="groundFactor" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="Coefficient of Rolling Resistance for the ground surface.">Ground Condition</label>
                        <select id="groundFactor" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="0" data-color="#a3be8c" disabled selected>Please select</option>
                            <option value="0.015" data-color="#d8dee9">Smooth Road (Asphalt/Concrete)</option>
                            <option value="0.05" data-color="#eceff4">Gravel</option>
                            <option value="0.08" data-color="#a3be8c">Firm Dirt / Grass</option>
                            <option value="0.20" data-color="#ebcb8b">Sand</option>
                            <option value="0.30" data-color="#816754">Mud</option>
                            <option value="0.50" data-color="#654321">Deep Mud / Clay</option>
                        </select>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="gradient" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="The angle of the slope the casualty vehicle is on.">Slope (°)</label>
                            <input type="number" id="gradient" placeholder="0-90" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="damageRes" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="Resistance from vehicle damage (e.g., locked wheels). Enter 0 if none.">Damage</label>
                            <input type="number" id="damageRes" placeholder="Tons" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="addRes" class="block text-sm font-medium text-gray-700 mb-1" data-tooltip="Any other resistance, like debris or suction from deep mud. Enter 0 if none.">Additional</label>
                            <input type="number" id="addRes" placeholder="Tons" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                     <div class="pt-6 flex flex-col sm:flex-row items-center justify-start space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="calculateBtn" class="w-full sm:w-auto flex-grow px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Calculate</button>
                        <button id="resetBtn" class="w-full sm:w-auto flex-grow px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105">Reset All</button>
                    </div>
                </div>

                <!-- Right Column: Visualization & Outputs -->
                <div class="lg:col-span-3 space-y-8">
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 flex justify-between items-center">
                            <span>Live Visualization</span>
                            <button id="viewTackleBtn" class="hidden px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">View Tackle</button>
                        </h2>
                        <div class="bg-gray-200 rounded-lg p-2 flex items-center justify-center min-h-[250px] lg:min-h-[300px] overflow-hidden">
                            <svg id="recoveryScene" viewBox="0 0 800 450" class="w-full h-auto"></svg>
                        </div>
                        <div class="absolute top-16 right-4 flex flex-col space-y-2">
                             <button id="zoomInBtn" class="bg-white/50 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white transition-colors" data-tooltip="Zoom In">+</button>
                             <button id="zoomOutBtn" class="bg-white/50 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white transition-colors" data-tooltip="Zoom Out">-</button>
                             <button id="zoomResetBtn" class="bg-white/50 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white transition-colors" data-tooltip="Reset View">⟲</button>
                        </div>
                    </div>

                    <div>
                         <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Calculation Results</h2>
                         <div class="space-y-4 bg-gray-50 p-6 rounded-lg">
                            <div class="flex justify-between items-center" data-tooltip="Force required to overcome the friction of the ground surface."><span class="font-medium text-gray-700">Rolling Resistance (Tons)</span><span id="outRR" class="font-bold text-lg text-indigo-600 bg-white px-4 py-1 rounded-md shadow-sm">0.0</span></div>
                             <div class="flex justify-between items-center" data-tooltip="Force required to pull the vehicle up the slope."><span class="font-medium text-gray-700">Gradient Resistance (Tons)</span><span id="outGR" class="font-bold text-lg text-indigo-600 bg-white px-4 py-1 rounded-md shadow-sm">0.0</span></div>
                             <div class="flex justify-between items-center" data-tooltip="Total force needed to move the casualty, before friction losses from tackle."><span class="font-medium text-gray-700">Total Resistance (Tons)</span><span id="outDBP" class="font-bold text-lg text-indigo-600 bg-white px-4 py-1 rounded-md shadow-sm">0.0</span></div>
                             <div class="flex justify-between items-center" data-tooltip="Added resistance from tackle friction (approx. 5% of total resistance per pulley)."><span class="font-medium text-gray-700">Friction Loss (Tackle)</span><span id="outSF" class="font-bold text-lg text-indigo-600 bg-white px-4 py-1 rounded-md shadow-sm">0.0</span></div>
                             <div class="flex justify-between items-center border-t pt-4 mt-4 border-gray-300" data-tooltip="The total winch pull required, including resistance and friction losses."><span class="font-bold text-gray-800 text-lg">Estimated Winch Pull (Tons)</span><span id="outEP" class="font-extrabold text-2xl text-green-600 bg-green-100 px-4 py-1 rounded-lg">0.0</span></div>
                             <div class="flex justify-between items-center" data-tooltip="The multiplication of force needed from tackle equipment (e.g., snatch blocks)."><span class="font-bold text-gray-800">Mechanical Advantage</span><span id="outMA" class="font-extrabold text-2xl text-blue-600 bg-blue-100 px-4 py-1 rounded-lg">1</span></div>
                             <div class="flex justify-between items-center" data-tooltip="The required pulley system configuration. Click to see diagram."><span class="font-bold text-gray-800">Tackle Layout Ratio</span><button id="outTL" class="font-extrabold text-2xl text-blue-600 bg-blue-100 px-4 py-1 rounded-lg hover:bg-blue-200 transition-colors">1 : 1</button></div>
                         </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal and Message Box -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="modal-content"><div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-gray-900" id="modal-title"></h3><button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div class="mt-4 text-sm text-gray-600" id="modal-body"></div></div><div class="bg-gray-50 px-6 py-3 text-right rounded-b-lg"><button id="okModalBtn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">OK</button></div></div></div>
    <div id="messageBox" class="fixed top-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-lg z-50 transform translate-x-[120%] transition-transform duration-300"><p id="messageBoxText"></p></div>
    <div id="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const casualtySelect = document.getElementById('casualty');
            const otherCasualtyInput = document.getElementById('otherCasualty');
            const recoveryVehSelect = document.getElementById('recoveryVeh');
            const otherRecoveryInput = document.getElementById('otherRecovery');
            const groundFactorSelect = document.getElementById('groundFactor');
            const gradientInput = document.getElementById('gradient');
            const damageResInput = document.getElementById('damageRes');
            const addResInput = document.getElementById('addRes');
            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const viewTackleBtn = document.getElementById('viewTackleBtn');
            const outTLButton = document.getElementById('outTL');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const zoomResetBtn = document.getElementById('zoomResetBtn');

            // --- Modal & Message Box Elements ---
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const okModalBtn = document.getElementById('okModalBtn');
            const aboutBtn = document.getElementById('aboutBtn');
            const appliancesBtn = document.getElementById('appliancesBtn');
            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            const tooltip = document.getElementById('tooltip');
            let messageTimeout;
            
            // --- Visualization ---
            const svg = document.getElementById('recoveryScene');
            const svgNS = "http://www.w3.org/2000/svg";
            let viewBox = { x: 0, y: 0, w: 800, h: 450 };
            let isPanning = false;
            let startPoint = { x: 0, y: 0 };
            
            // --- SVG Asset Library ---
            const vehicleSVGs = {
                jeep: `<g transform="translate(-40,-25)"><path d="M15 25L10 20H5V10H20V20H20L15 25Z" fill="#a3be8c" stroke="#4c566a" stroke-width="2"/><path d="M20 10H5L2 5H23L20 10Z" fill="#a3be8c" stroke="#4c566a" stroke-width="2"/><rect x="5" y="0" width="15" height="5" fill="none" stroke="#4c566a" stroke-width="2"/><circle cx="7" cy="25" r="5" fill="#4c566a"/><circle cx="18" cy="25" r="5" fill="#4c566a"/></g>`,
                truck: `<g transform="translate(-50,-30)"><rect x="0" y="10" width="70" height="20" fill="#d08770" rx="3" stroke="#4c566a" stroke-width="2"/><rect x="70" y="0" width="20" height="30" fill="#bf616a" rx="3" stroke="#4c566a" stroke-width="2"/><circle cx="15" cy="30" r="7" fill="#4c566a"/><circle cx="55" cy="30" r="7" fill="#4c566a"/></g>`,
                tank: `<g transform="translate(-60,-30)"><path d="M0 10 H100 L110 0 H10 V-10 H90 V0 H110 L120 10 V20 H0 Z" fill="#5e81ac" stroke="#4c566a" stroke-width="2"/><rect x="-5" y="20" width="130" height="10" fill="#4c566a" rx="5"/><path d="M40 -10 L60 -10 L60 -20 L40 -20 Z" fill="#81a1c1" stroke="#4c566a" stroke-width="2"/><line x1="50" y1="-20" x2="50" y2="-30" stroke="#4c566a" stroke-width="2"/><rect x="20" y="-5" width="60" height="10" fill="#88c0d0" rx="3" stroke="#4c566a" stroke-width="2"/><line x1="80" y1="0" x2="130" y2="0" stroke="#4c566a" stroke-width="5"/></g>`,
                anchor: `<g transform="translate(-20, -30)"><path d="M0 30 Q5 20, 10 30 T20 30 T30 30 T40 30" fill="none" stroke="#654321" stroke-width="4"/><path d="M10 20 L5 10 L15 10 Z" fill="#a3be8c"/><path d="M30 20 L25 10 L35 10 Z" fill="#a3be8c"/></g>`,
                pulley: `<g><circle cx="0" cy="0" r="10" fill="#d8dee9" stroke="#4c566a" stroke-width="2"/><circle cx="0" cy="0" r="3" fill="#4c566a"/></g>`
            };
            
            // --- Helper Functions ---
            const showMessage = (message, duration = 3000) => {
                clearTimeout(messageTimeout);
                messageBoxText.textContent = message;
                messageBox.classList.remove('translate-x-[120%]');
                messageTimeout = setTimeout(() => messageBox.classList.add('translate-x-[120%]'), duration);
            };
            
            const showModal = (title, bodyHtml) => {
                modalTitle.textContent = title;
                modalBody.innerHTML = bodyHtml;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            };

            const hideModal = () => {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200);
            };

            const animateValue = (el, start, end, duration) => {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    el.innerHTML = (progress * (end - start) + start).toFixed(1);
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            };
            
            const resetForm = () => {
                document.querySelectorAll('select, input').forEach(el => {
                    if(el.tagName === 'SELECT') el.selectedIndex = 0;
                    else el.value = '';
                });
                otherCasualtyInput.classList.add('hidden');
                otherRecoveryInput.classList.add('hidden');
                ['outRR', 'outGR', 'outDBP', 'outSF', 'outEP'].forEach(id => document.getElementById(id).textContent = '0.0');
                document.getElementById('outMA').textContent = '1';
                outTLButton.textContent = '1 : 1';
                viewTackleBtn.classList.add('hidden');
                updateVisualization(getLiveConfig());
                resetZoom();
            };

            // --- Main Calculation Logic ---
            const performCalculation = () => {
                const casualtyWeight = casualtySelect.value === 'other' ? parseFloat(otherCasualtyInput.value) : parseFloat(casualtySelect.value);
                const recoveryPull = recoveryVehSelect.value === 'other' ? parseFloat(otherRecoveryInput.value) : parseFloat(recoveryVehSelect.value);
                const coeffRollingRes = parseFloat(groundFactorSelect.value);
                const gradient = parseFloat(gradientInput.value) || 0;
                const damageRes = parseFloat(damageResInput.value) || 0;
                const addRes = parseFloat(addResInput.value) || 0;

                if (!(casualtyWeight > 0)) { showMessage("Please select a valid casualty vehicle weight."); return; }
                if (!(recoveryPull > 0)) { showMessage("Please select a valid recovery vehicle pull force."); return; }
                if (!(coeffRollingRes > 0)) { showMessage("Please select a valid ground condition."); return; }
                if (gradient < 0 || gradient > 90) { showMessage("Gradient must be between 0 and 90 degrees."); return; }

                const rollingRes = casualtyWeight * coeffRollingRes;
                const gradientRes = casualtyWeight * Math.sin(gradient * Math.PI / 180);
                const totalResistance = rollingRes + gradientRes + damageRes + addRes;
                
                let ma = 1;
                let estimatedWinchPull, frictionLoss;
                while (true) {
                    if (ma > 20) { showMessage("Recovery not feasible. Required pull exceeds practical limits."); return; }
                    frictionLoss = totalResistance * 0.05 * (ma - 1);
                    estimatedWinchPull = (totalResistance + frictionLoss) / ma;
                    if (estimatedWinchPull <= recoveryPull) break;
                    ma++;
                }

                animateValue(document.getElementById('outRR'), 0, rollingRes, 500);
                animateValue(document.getElementById('outGR'), 0, gradientRes, 500);
                animateValue(document.getElementById('outDBP'), 0, totalResistance, 500);
                animateValue(document.getElementById('outSF'), 0, frictionLoss, 500);
                animateValue(document.getElementById('outEP'), 0, estimatedWinchPull, 800);
                document.getElementById('outMA').textContent = ma;
                outTLButton.textContent = `${ma} : 1`;
                viewTackleBtn.classList.toggle('hidden', ma <= 1);
                updateVisualization(getLiveConfig());
            };
            
            // --- NEW: Accurate Tackle Drawing Logic ---
            const generateTackleSVG = (ma) => {
                if (ma <= 1) return { html: '', path: 'M 200 -20 L -150 -25' };

                let html = '';
                let path = 'M 200 -20'; // Start at recovery vehicle
                const anchorPos = { x: 0, y: -40 };
                const casualtyAttachPoint = { x: -150, y: -25 };
                
                html += `<g transform="translate(${anchorPos.x}, ${anchorPos.y})">${vehicleSVGs.anchor}</g>`;

                let casualtyPulleys = Math.floor(ma / 2);
                let anchorPulleys = Math.floor((ma - 1) / 2);
                
                let currentPoint = {x: 200, y: -20};
                let lineGoesTo = 'casualty';

                for (let i = 0; i < ma - 1; i++) {
                    if (lineGoesTo === 'casualty') {
                        const pulleyNum = Math.floor(i / 2);
                        const pulleyPos = { x: casualtyAttachPoint.x + 20 + pulleyNum * 25, y: casualtyAttachPoint.y };
                        html += `<g transform="translate(${pulleyPos.x}, ${pulleyPos.y})">${vehicleSVGs.pulley}</g>`;
                        path += ` L ${pulleyPos.x} ${pulleyPos.y}`;
                        lineGoesTo = 'anchor';
                    } else {
                        const pulleyNum = Math.floor((i-1) / 2);
                        const pulleyPos = { x: anchorPos.x - 20 - pulleyNum * 25, y: anchorPos.y + 15 };
                        html += `<g transform="translate(${pulleyPos.x}, ${pulleyPos.y})">${vehicleSVGs.pulley}</g>`;
                        path += ` L ${pulleyPos.x} ${pulleyPos.y}`;
                        lineGoesTo = 'casualty';
                    }
                }
                
                // Final line attachment
                if (ma % 2 === 0) { // Attaches to anchor
                    path += ` L ${anchorPos.x + 20} ${anchorPos.y + 15}`;
                } else { // Attaches to casualty
                    path += ` L ${casualtyAttachPoint.x} ${casualtyAttachPoint.y}`;
                }

                return { html, path };
            };
            
            const updateVisualization = (config) => {
                svg.innerHTML = '';
                const { grad = 0, casualtyType = 'truck', recoveryType = 'truck', groundColor = '#e5e7eb', tackleRatio = 1 } = config;

                const scene = document.createElementNS(svgNS, 'g');
                const groundGroup = document.createElementNS(svgNS, 'g');
                groundGroup.setAttribute('transform', `rotate(${-grad})`);

                const ground = document.createElementNS(svgNS, 'path');
                ground.setAttribute('d', 'M-1000,0 L1000,0');
                ground.setAttribute('stroke', groundColor);
                ground.setAttribute('stroke-width', '80');
                ground.setAttribute('stroke-linecap', 'round');
                groundGroup.appendChild(ground);
                
                const casualtyG = document.createElementNS(svgNS, 'g');
                casualtyG.setAttribute('transform', 'translate(-150, -40)');
                casualtyG.innerHTML = vehicleSVGs[casualtyType] || vehicleSVGs.truck;
                groundGroup.appendChild(casualtyG);

                const recoveryG = document.createElementNS(svgNS, 'g');
                recoveryG.setAttribute('transform', 'translate(250, -45)');
                recoveryG.innerHTML = vehicleSVGs[recoveryType] || vehicleSVGs.truck;
                groundGroup.appendChild(recoveryG);

                const tackleData = generateTackleSVG(tackleRatio);
                const tackleGroup = document.createElementNS(svgNS, 'g');
                tackleGroup.innerHTML = tackleData.html;
                groundGroup.appendChild(tackleGroup);

                const winchLine = document.createElementNS(svgNS, 'path');
                winchLine.setAttribute('d', tackleData.path);
                winchLine.setAttribute('fill', 'none');
                winchLine.setAttribute('stroke', '#4c566a');
                winchLine.setAttribute('stroke-width', '2');
                winchLine.classList.add('winch-line');
                groundGroup.appendChild(winchLine);

                scene.appendChild(groundGroup);
                svg.appendChild(scene);
                scene.setAttribute('transform', `translate(400, 350)`);
            };

            const showTackleDiagram = () => {
                const ma = parseInt(document.getElementById('outMA').textContent);
                if (isNaN(ma) || ma <= 1) {
                    showModal('Tackle Layout', '<p>No mechanical advantage is required for this recovery (1:1 direct pull).</p>');
                    return;
                }
                
                let diagramSVG = `<svg viewBox="0 0 600 300" xmlns="${svgNS}">
                    <style>.txt{font-family:Inter,sans-serif;font-size:16px;}.light{stroke:#9ca3af;}.heavy{stroke:#374151;stroke-width:2;fill:none;}</style>
                    <g transform="translate(500, 200)">${vehicleSVGs.truck}</g><text x="470" y="240" class="txt">Recovery</text>
                    <g transform="translate(100, 200)">${vehicleSVGs.truck}</g><text x="70" y="240" class="txt">Casualty</text>
                `;

                const casualtyPulleys = Math.floor(ma / 2);
                const anchorPulleys = Math.floor((ma - 1) / 2);
                const totalPulleys = casualtyPulleys + anchorPulleys;
                
                let path = 'M 450 180';
                
                if (totalPulleys > 0) {
                     diagramSVG += `<g transform="translate(300, 100)">${vehicleSVGs.anchor}</g><text x="275" y="140" class="txt">Anchor</text>`;
                }
                
                // Draw pulleys and path
                for(let i = 1; i <= totalPulleys; i++) {
                    if (i % 2 !== 0) { // Go to casualty pulley
                        const pulleyX = 120 + ((i-1)/2) * 25;
                        diagramSVG += `<g transform="translate(${pulleyX}, 180)">${vehicleSVGs.pulley}</g>`;
                        path += ` L ${pulleyX} 180`;
                    } else { // Go to anchor pulley
                        const pulleyX = 320 - (i/2 - 1) * 25;
                        diagramSVG += `<g transform="translate(${pulleyX}, 100)">${vehicleSVGs.pulley}</g>`;
                        path += ` L ${pulleyX} 100`;
                    }
                }
                
                // Final attachment
                if (ma % 2 === 0) { path += ` L 300 100`; } 
                else { path += ` L 100 180`; }
                
                diagramSVG += `<path d="${path.replace(/L/g, ' C ')}" class="heavy winch-line" /></svg>`;
                showModal(`Tackle Layout for ${ma} : 1`, diagramSVG);
            }

            // --- Pan & Zoom Logic ---
            const setSVGViewBox = () => svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
            const resetZoom = () => { viewBox = { x: 0, y: 0, w: 800, h: 450 }; setSVGViewBox(); };

            svg.addEventListener('mousedown', (e) => { isPanning = true; startPoint = { x: e.clientX, y: e.clientY }; });
            svg.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                let endPoint = { x: e.clientX, y: e.clientY };
                let dx = (startPoint.x - endPoint.x) * (viewBox.w / svg.getBoundingClientRect().width);
                let dy = (startPoint.y - endPoint.y) * (viewBox.h / svg.getBoundingClientRect().height);
                viewBox.x += dx;
                viewBox.y += dy;
                setSVGViewBox();
                startPoint = endPoint;
            });
            svg.addEventListener('mouseup', () => isPanning = false);
            svg.addEventListener('mouseleave', () => isPanning = false);
            svg.addEventListener('wheel', (e) => {
                e.preventDefault();
                const { left, top, width, height } = svg.getBoundingClientRect();
                const mouseX = e.clientX - left;
                const mouseY = e.clientY - top;
                const svgX = viewBox.x + (mouseX / width) * viewBox.w;
                const svgY = viewBox.y + (mouseY / height) * viewBox.h;

                const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                viewBox.w *= zoomFactor;
                viewBox.h *= zoomFactor;
                viewBox.x = svgX - (mouseX / width) * viewBox.w;
                viewBox.y = svgY - (mouseY / height) * viewBox.h;
                setSVGViewBox();
            });
            zoomInBtn.addEventListener('click', () => { viewBox.w *= 0.8; viewBox.h *= 0.8; setSVGViewBox(); });
            zoomOutBtn.addEventListener('click', () => { viewBox.w *= 1.2; viewBox.h *= 1.2; setSVGViewBox(); });
            zoomResetBtn.addEventListener('click', resetZoom);

            // --- Initial Setup and Event Listeners ---
            const getLiveConfig = () => ({
                grad: parseFloat(gradientInput.value) || 0,
                casualtyType: casualtySelect.options[casualtySelect.selectedIndex].dataset.type,
                recoveryType: recoveryVehSelect.options[recoveryVehSelect.selectedIndex].dataset.type,
                groundColor: groundFactorSelect.options[groundFactorSelect.selectedIndex].dataset.color,
                tackleRatio: parseInt(document.getElementById('outMA').textContent) || 1,
            });
            
            [casualtySelect, recoveryVehSelect, groundFactorSelect, gradientInput].forEach(el => {
                el.addEventListener('change', () => updateVisualization(getLiveConfig()));
            });

            const setupOtherInput = (selectEl, inputEl) => {
                selectEl.addEventListener('change', (e) => {
                    inputEl.classList.toggle('hidden', e.target.value !== 'other');
                    if (e.target.value === 'other') inputEl.focus();
                });
            };
            setupOtherInput(casualtySelect, otherCasualtyInput);
            setupOtherInput(recoveryVehSelect, otherRecoveryInput);
            
            calculateBtn.addEventListener('click', performCalculation);
            resetBtn.addEventListener('click', resetForm);
            
            aboutBtn.addEventListener('click', () => showModal('About this Software', `<p class="mb-2"><strong>Recovery Calculation Software</strong></p><p class="mb-2">Version: 7.0 (Responsive & Accurate Viz)</p><p class="mb-2">This interactive tool assists in calculating and visualizing the forces for vehicle recovery operations using standard physics formulas.</p><p>Original concept by RFM. Reworked for accuracy and usability.</p>`));
            appliancesBtn.addEventListener('click', () => showModal('Recovery Appliances', `<h4 class="font-semibold text-gray-800 mb-2">Common Recovery Appliances</h4><ul class="list-disc list-inside space-y-1"><li>Snatch Blocks (Pulleys)</li><li>Tow Ropes and Cables</li><li>Shackles and Hooks</li><li>Winches</li><li>Ground Anchors / Spades</li><li>Lever Hoists (Come-alongs)</li></ul>`));
            [closeModalBtn, okModalBtn].forEach(btn => btn.addEventListener('click', hideModal));
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
            [viewTackleBtn, outTLButton].forEach(btn => btn.addEventListener('click', showTackleDiagram));
            
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                el.addEventListener('mouseenter', e => {
                    tooltip.textContent = e.currentTarget.dataset.tooltip;
                    tooltip.style.display = 'block';
                });
                el.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                el.addEventListener('mousemove', e => {
                    tooltip.style.left = `${e.pageX + 15}px`;
                    tooltip.style.top = `${e.pageY + 15}px`;
                });
            });

            resetForm(); // Initialize the app state
        });
    </script>
</body>
</html>
