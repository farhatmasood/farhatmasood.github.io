<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactical Recovery Analysis System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Print Styles */
        @media print {
            body { background-color: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page-break { page-break-after: always; }
            /* Reset Tailwind dark mode overrides for print */
            .bg-slate-900 { background-color: white !important; }
            .text-slate-100 { color: black !important; }
            .border-slate-700 { border-color: #ddd !important; }
        }
        .print-only { display: none; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 overflow-hidden h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useRef, useMemo, useCallback } = React;

        // --- ICONS (Lucide Replacements for Single File) ---
        const Icon = ({ path, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {path}
            </svg>
        );

        const AnchorIcon = (p) => <Icon {...p} path={<><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></>} />;
        const TruckIcon = (p) => <Icon {...p} path={<><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>} />;
        const SettingsIcon = (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const MoveVerticalIcon = (p) => <Icon {...p} path={<><polyline points="8 18 12 22 16 18"/><polyline points="8 6 12 2 16 6"/><line x1="12" y1="2" x2="12" y2="22"/></>} />;
        const ActivityIcon = (p) => <Icon {...p} path={<><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></>} />;
        const ZoomInIcon = (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></>} />;
        const ZoomOutIcon = (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></>} />;
        const RotateCcwIcon = (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />;
        const AlertTriangleIcon = (p) => <Icon {...p} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
        const ChevronsRightIcon = (p) => <Icon {...p} path={<><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></>} />;
        const PrinterIcon = (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />;
        const SigmaIcon = (p) => <Icon {...p} path={<><path d="M18 7V4H6l6 8-6 8h12v-3"/></>} />;
        const XIcon = (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;

        // --- DATA ---
        const CASUALTIES = [
            { id: 'c_jeep', name: 'Jeep / Light Utility (1T)', weight: 1, type: 'jeep' },
            { id: 'c_truck34', name: '3/4 Ton Truck', weight: 3, type: 'truck' },
            { id: 'c_truck25', name: '2.5 Ton Truck', weight: 6, type: 'truck' },
            { id: 'c_truck5', name: '5 Ton Recovery', weight: 18, type: 'truck' },
            { id: 'c_m113', name: 'APC M113 (12T)', weight: 12, type: 'tank' },
            { id: 'c_m48', name: 'Tank M-48 (48T)', weight: 48, type: 'tank' },
            { id: 'c_t80', name: 'Tank T-80 (46T)', weight: 46, type: 'tank' },
            { id: 'c_other', name: 'Custom Input', weight: 0, type: 'truck' },
        ];

        const RECOVERY_VEHICLES = [
            { id: 'r_m816', name: 'Wrecker M-816 (22.5T)', weight: 22.5, type: 'wrecker' },
            { id: 'r_m88', name: 'ARV M-88A1 (45T)', weight: 45, type: 'tank' },
            { id: 'r_fiat', name: 'FIAT Wrecker (6T)', weight: 6, type: 'truck' },
            { id: 'r_other', name: 'Custom Input', weight: 0, type: 'wrecker' },
        ];

        const SURFACES = [
            { value: 0.015, label: 'Asphalt / Concrete', color: '#64748b' },
            { value: 0.05, label: 'Gravel', color: '#94a3b8' },
            { value: 0.08, label: 'Firm Dirt / Grass', color: '#4d7c0f' },
            { value: 0.20, label: 'Sand', color: '#d97706' },
            { value: 0.30, label: 'Mud', color: '#78350f' },
            { value: 0.50, label: 'Deep Mud / Clay', color: '#451a03' },
        ];

        // --- COMPONENTS ---

        // Math Equation Renderer
        const MathEq = React.memo(({ left, num, den }) => (
            <div className="flex items-center font-serif text-lg my-3 justify-center bg-slate-800/80 p-3 rounded border border-slate-600 shadow-inner">
                <span className="italic mr-3 font-bold text-indigo-300">{left}</span>
                <span className="mr-3 text-slate-400">=</span>
                <div className="flex flex-col items-center">
                    <div className="border-b border-slate-400 px-3 mb-1 pb-1 text-slate-200">{num}</div>
                    <div className="text-slate-200">{den}</div>
                </div>
            </div>
        ));

        // SVG Vehicle Assets
        const JeepSVG = React.memo(({ color = "#60a5fa" }) => (
            <g transform="scale(0.8)">
                <path d="M5 25 L0 20 H-5 V10 H20 V20 H25 L20 25 Z" fill={color} stroke="#e2e8f0" strokeWidth="2"/>
                <rect x="-5" y="0" width="15" height="10" fill="none" stroke="#e2e8f0" strokeWidth="2"/>
                <circle cx="-2" cy="25" r="6" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
                <circle cx="18" cy="25" r="6" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
            </g>
        ));

        const TruckSVG = React.memo(({ color = "#f59e0b" }) => (
            <g transform="scale(0.9)">
                <rect x="-20" y="5" width="60" height="20" rx="2" fill={color} stroke="#e2e8f0" strokeWidth="2"/>
                <rect x="40" y="-5" width="20" height="30" rx="2" fill="#334155" stroke="#e2e8f0" strokeWidth="2"/>
                <circle cx="0" cy="25" r="7" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
                <circle cx="45" cy="25" r="7" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
            </g>
        ));

        const TankSVG = React.memo(({ color = "#10b981" }) => (
            <g transform="scale(0.8)">
                <path d="M-30 15 H50 L60 5 H-20 V-5 H40 V5 H60 L70 15 V25 H-30 Z" fill={color} stroke="#e2e8f0" strokeWidth="2"/>
                <path d="M10 -5 L30 -5 L30 -15 L10 -15 Z" fill="#334155" stroke="#e2e8f0" strokeWidth="2"/>
                <rect x="-10" y="0" width="50" height="8" rx="2" fill="#064e3b"/>
                <line x1="30" y1="-15" x2="60" y2="-15" stroke="#e2e8f0" strokeWidth="3"/>
                <rect x="-35" y="20" width="110" height="8" rx="4" fill="#1e293b"/>
            </g>
        ));

        const WreckerSVG = React.memo(({ color = "#ef4444" }) => (
            <g transform="scale(1)">
                <rect x="-20" y="0" width="50" height="20" fill={color} stroke="#e2e8f0" strokeWidth="2"/>
                <path d="M30 0 L50 0 L50 20 L30 20 Z" fill="#334155" stroke="#e2e8f0" strokeWidth="2"/>
                <path d="M0 0 L-20 -25 L-15 -27 L5 0 Z" fill="#94a3b8"/>
                <circle cx="0" cy="20" r="7" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
                <circle cx="35" cy="20" r="7" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
            </g>
        ));

        const VehicleRenderer = React.memo(({ type, role }) => {
            if (role === 'casualty') {
                if (type === 'jeep') return <JeepSVG color="#60a5fa" />;
                if (type === 'tank') return <TankSVG color="#10b981" />;
                return <TruckSVG color="#f59e0b" />;
            } else {
                if (type === 'tank') return <TankSVG color="#64748b" />;
                return <WreckerSVG color="#ef4444" />;
            }
        });

        // --- MAIN APPLICATION ---
        function RecoveryApp() {
            const [casualtyId, setCasualtyId] = useState('c_truck25');
            const [customCasualtyWeight, setCustomCasualtyWeight] = useState('10');
            
            const [recoveryId, setRecoveryId] = useState('r_m816');
            const [customRecoveryPull, setCustomRecoveryPull] = useState('20');

            const [groundCoeff, setGroundCoeff] = useState(0.08);
            const [gradient, setGradient] = useState(15);
            const [damageRes, setDamageRes] = useState('0');
            const [addRes, setAddRes] = useState('0');
            
            const [zoom, setZoom] = useState(1);
            const [isDraggingSlope, setIsDraggingSlope] = useState(false);
            const [showEquations, setShowEquations] = useState(false);
            
            const svgRef = useRef(null);

            // Validation & Calculations
            const casualtyWeight = useMemo(() => {
                const base = CASUALTIES.find(c => c.id === casualtyId) || CASUALTIES[0];
                if (base.id !== 'c_other') return base.weight;
                const w = parseFloat(customCasualtyWeight);
                return isNaN(w) || w < 0 ? 0 : w;
            }, [casualtyId, customCasualtyWeight]);

            const recoveryPull = useMemo(() => {
                const base = RECOVERY_VEHICLES.find(r => r.id === recoveryId) || RECOVERY_VEHICLES[0];
                if (base.id !== 'r_other') return base.weight;
                const p = parseFloat(customRecoveryPull);
                return isNaN(p) || p <= 0 ? 0.1 : p;
            }, [recoveryId, customRecoveryPull]);

            const dmgVal = parseFloat(damageRes) || 0;
            const addVal = parseFloat(addRes) || 0;

            const results = useMemo(() => {
                const rad = (gradient * Math.PI) / 180;
                
                // Physics:
                // R_roll = W * cos(theta) * Crr
                const rollingRes = casualtyWeight * Math.cos(rad) * groundCoeff;
                // R_grad = W * sin(theta)
                const gradientRes = casualtyWeight * Math.sin(rad);
                const totalRes = rollingRes + gradientRes + Math.max(0, dmgVal) + Math.max(0, addVal);

                let ma = 1;
                let frictionLoss = 0;
                let estimatedPull = totalRes;
                let isFeasible = true;

                // MA Loop with Safety Break
                while (ma <= 20) {
                    const numSheaves = ma - 1;
                    const frictionFactor = 0.10 * numSheaves; // 10% per sheave
                    const loadWithFriction = totalRes * (1 + frictionFactor);
                    estimatedPull = loadWithFriction / ma;
                    frictionLoss = loadWithFriction - totalRes;

                    if (estimatedPull <= recoveryPull) break;
                    ma++;
                }

                if (ma > 12) isFeasible = false;

                return { rollingRes, gradientRes, totalRes, ma, frictionLoss, estimatedPull, isFeasible };
            }, [casualtyWeight, groundCoeff, gradient, dmgVal, addVal, recoveryPull]);

            // Handlers
            const handleSvgMouseMove = useCallback((e) => {
                if (!isDraggingSlope || !svgRef.current) return;
                
                const rect = svgRef.current.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2 + 50; 
                
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const deltaY = centerY - mouseY;
                const deltaX = mouseX - centerX;
                let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                
                if (angle > 60) angle = 60;
                if (angle < -20) angle = -20;
                
                setGradient(Math.round(angle));
            }, [isDraggingSlope]);

            const handleDragStart = useCallback(() => setIsDraggingSlope(true), []);
            const handleDragEnd = useCallback(() => setIsDraggingSlope(false), []);

            const handleInputChange = (setter) => (e) => {
                const val = e.target.value;
                if (val === '' || /^\d*\.?\d*$/.test(val)) setter(val);
            };

            const renderTackle = useMemo(() => {
                const casualtyX = -120;
                const recoveryX = 220;
                const yLevel = -20;
                
                const lines = [];
                const pulleys = [];
                const visualMA = Math.min(results.ma, 12); 

                let currentX = recoveryX;
                let currentY = yLevel;
                let targetX = casualtyX; 
                let targetY = yLevel;

                for (let i = 0; i < visualMA; i++) {
                    lines.push(
                        <line 
                            key={`line-${i}`}
                            x1={currentX} y1={currentY} x2={targetX} y2={targetY} 
                            stroke={results.isFeasible ? "#cbd5e1" : "#fca5a5"} 
                            strokeWidth="2" strokeDasharray="5,5" opacity="0.9"
                        >
                           <animate attributeName="stroke-dashoffset" from="10" to="0" dur={`${2/visualMA}s`} repeatCount="indefinite" />
                        </line>
                    );

                    if (i < visualMA - 1) {
                        pulleys.push(
                            <g key={`pulley-${i}`} transform={`translate(${targetX}, ${targetY})`}>
                                <circle r="6" fill="#475569" stroke="#cbd5e1" strokeWidth="2" />
                                <circle r="2" fill="#cbd5e1" />
                            </g>
                        );
                    } else {
                        pulleys.push(
                            <circle key={`term-${i}`} cx={targetX} cy={targetY} r="4" 
                                fill={results.isFeasible ? "#10b981" : "#ef4444"} stroke="white" strokeWidth="1" 
                            />
                        );
                    }

                    const tempX = currentX;
                    currentX = targetX;
                    targetX = tempX === recoveryX ? casualtyX : recoveryX; 
                    currentY = targetY; 
                    targetY = yLevel - ((i + 1) * 4);
                }

                return <g>{lines}{pulleys}</g>;
            }, [results.ma, results.isFeasible]);

            const casualtyType = CASUALTIES.find(c => c.id === casualtyId)?.type || 'truck';
            const recoveryType = RECOVERY_VEHICLES.find(r => r.id === recoveryId)?.type || 'wrecker';

            return (
                <div 
                    className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white overflow-hidden flex flex-col"
                    onMouseUp={handleDragEnd}
                    onMouseLeave={handleDragEnd}
                >
                    {/* Header */}
                    <header className="no-print bg-slate-800 border-b border-slate-700 p-4 shadow-lg z-20 flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-indigo-500/20 shadow-xl">
                                <AnchorIcon className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight text-white">RECOVERY <span className="text-indigo-400">ANALYSIS</span></h1>
                                <p className="text-xs text-slate-400 font-mono">TACTICAL COMPUTING SYSTEM</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4 text-sm font-medium">
                            <button onClick={() => setShowEquations(true)} className="p-2 text-slate-400 hover:text-white transition-colors" title="View Equations">
                                <SigmaIcon className="w-5 h-5" />
                            </button>
                            <button onClick={() => window.print()} className="p-2 text-slate-400 hover:text-white transition-colors" title="Print Report">
                                <PrinterIcon className="w-5 h-5" />
                            </button>
                            <div className={`hidden md:flex items-center space-x-2 px-3 py-1 rounded-full border ${results.isFeasible ? 'bg-emerald-950/30 border-emerald-800 text-emerald-400' : 'bg-red-950/30 border-red-800 text-red-400'}`}>
                                <ActivityIcon className="w-4 h-4" />
                                <span>SYSTEM: {results.isFeasible ? 'READY' : 'FAULT'}</span>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="no-print flex-1 overflow-hidden flex flex-col lg:flex-row relative">
                        {/* Left Panel: Inputs */}
                        <aside className="w-full lg:w-96 bg-slate-800/50 backdrop-blur-sm border-r border-slate-700 overflow-y-auto p-6 z-10 shadow-2xl flex flex-col gap-6">
                            
                            <section>
                                <div className="flex items-center gap-2 mb-4 text-indigo-300 font-semibold uppercase tracking-wider text-xs">
                                    <TruckIcon className="w-4 h-4" /> Casualty Parameters
                                </div>
                                <div className="space-y-4">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400">Vehicle Type</label>
                                        <select 
                                            value={casualtyId} onChange={(e) => setCasualtyId(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-md p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                        >
                                            {CASUALTIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                    {casualtyId === 'c_other' && (
                                        <div className="space-y-1">
                                            <label className="text-xs text-slate-400">Weight (Tons)</label>
                                            <input type="text" inputMode="decimal" value={customCasualtyWeight} onChange={handleInputChange(setCustomCasualtyWeight)}
                                                className="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm focus:border-indigo-500 outline-none" />
                                        </div>
                                    )}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1">
                                            <label className="text-xs text-slate-400">Damage Res. (T)</label>
                                            <input type="text" inputMode="decimal" value={damageRes} onChange={handleInputChange(setDamageRes)}
                                                className="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm focus:border-indigo-500 outline-none" />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs text-slate-400">Misc Res. (T)</label>
                                            <input type="text" inputMode="decimal" value={addRes} onChange={handleInputChange(setAddRes)}
                                                className="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm focus:border-indigo-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section className="border-t border-slate-700 pt-6">
                                <div className="flex items-center gap-2 mb-4 text-emerald-300 font-semibold uppercase tracking-wider text-xs">
                                    <MoveVerticalIcon className="w-4 h-4" /> Environment
                                </div>
                                <div className="space-y-4">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400">Ground Surface</label>
                                        <select value={groundCoeff} onChange={(e) => setGroundCoeff(parseFloat(e.target.value))}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-md p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                                            {SURFACES.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-1">
                                        <div className="flex justify-between">
                                            <label className="text-xs text-slate-400">Gradient (Slope)</label>
                                            <span className="text-xs font-mono text-emerald-400">{gradient}°</span>
                                        </div>
                                        <input type="range" min="-20" max="60" value={gradient} onChange={(e) => setGradient(parseInt(e.target.value))}
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" />
                                    </div>
                                </div>
                            </section>

                            <section className="border-t border-slate-700 pt-6">
                                <div className="flex items-center gap-2 mb-4 text-blue-300 font-semibold uppercase tracking-wider text-xs">
                                    <SettingsIcon className="w-4 h-4" /> Recovery Asset
                                </div>
                                <div className="space-y-4">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400">Wrecker / Winch</label>
                                        <select value={recoveryId} onChange={(e) => setRecoveryId(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-md p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            {RECOVERY_VEHICLES.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                        </select>
                                    </div>
                                    {recoveryId === 'r_other' && (
                                        <div className="space-y-1">
                                            <label className="text-xs text-slate-400">Max Pull (Tons)</label>
                                            <input type="text" inputMode="decimal" value={customRecoveryPull} onChange={handleInputChange(setCustomRecoveryPull)}
                                                className="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm focus:border-blue-500 outline-none" />
                                        </div>
                                    )}
                                </div>
                            </section>
                        </aside>

                        {/* Center: Visualization */}
                        <div className="flex-1 relative bg-slate-950 flex flex-col">
                            <div className="absolute top-4 right-4 z-10 flex flex-col gap-2">
                                <button onClick={() => setZoom(z => Math.min(z + 0.1, 2))} className="p-2 bg-slate-800 text-slate-200 rounded-full hover:bg-slate-700 shadow-lg border border-slate-700"><ZoomInIcon className="w-5 h-5"/></button>
                                <button onClick={() => setZoom(z => Math.max(z - 0.1, 0.5))} className="p-2 bg-slate-800 text-slate-200 rounded-full hover:bg-slate-700 shadow-lg border border-slate-700"><ZoomOutIcon className="w-5 h-5"/></button>
                                <button onClick={() => {setZoom(1); setGradient(0);}} className="p-2 bg-slate-800 text-slate-200 rounded-full hover:bg-slate-700 shadow-lg border border-slate-700"><RotateCcwIcon className="w-5 h-5"/></button>
                            </div>

                            <div className={`flex-1 overflow-hidden transition-cursor duration-200 ${isDraggingSlope ? 'cursor-grabbing' : 'cursor-default'}`} onMouseMove={handleSvgMouseMove}>
                                <svg ref={svgRef} className="w-full h-full select-none" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid meet">
                                    <defs>
                                        <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style={{stopColor:'#0f172a', stopOpacity:1}} />
                                            <stop offset="100%" style={{stopColor:'#1e293b', stopOpacity:1}} />
                                        </linearGradient>
                                        <pattern id="groundPattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                             <line x1="0" y1="0" x2="20" y2="20" stroke={SURFACES.find(s=>s.value===groundCoeff)?.color || '#334155'} strokeWidth="1" opacity="0.3"/>
                                        </pattern>
                                        <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ef4444" /></marker>
                                        <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b" /></marker>
                                        <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" /></marker>
                                    </defs>

                                    <rect width="100%" height="100%" fill="url(#skyGradient)" />
                                    <g transform={`translate(400, 300) scale(${zoom})`}>
                                        <g transform={`rotate(${-gradient})`} style={{ transition: isDraggingSlope ? 'none' : 'transform 0.3s ease-out' }}>
                                            <path d="M -1000 0 L 1000 0" stroke={SURFACES.find(s=>s.value===groundCoeff)?.color || '#64748b'} strokeWidth="40" strokeLinecap="round"/>
                                            <rect x="-1000" y="-20" width="2000" height="40" fill="url(#groundPattern)" opacity="0.5" />
                                            <g className="cursor-grab hover:opacity-100 opacity-60 transition-opacity" onMouseDown={handleDragStart}>
                                                <circle cx="350" cy="0" r="15" fill="white" fillOpacity="0.1" stroke="white" strokeDasharray="2 2"/>
                                                <text x="350" y="30" textAnchor="middle" fill="white" fontSize="10" fontWeight="bold">DRAG SLOPE</text>
                                            </g>

                                            <g transform="translate(-150, -25)">
                                                <VehicleRenderer type={casualtyType} role="casualty" />
                                                <g opacity="0.9">
                                                    <g transform={`rotate(${gradient})`}>
                                                        <line x1="0" y1="0" x2="0" y2={50 + (casualtyWeight * 1.5)} stroke="#ef4444" strokeWidth="4" markerEnd="url(#arrowhead-red)" />
                                                        <text x="8" y={60 + (casualtyWeight * 1.5)} fill="#ef4444" fontSize="12" fontWeight="bold" style={{textShadow: '0px 0px 4px black'}}>W ({casualtyWeight}T)</text>
                                                    </g>
                                                    <line x1="0" y1="0" x2={-50 - (results.totalRes * 2)} y2="0" stroke="#f59e0b" strokeWidth="4" markerEnd="url(#arrowhead-orange)" />
                                                    <text x={-60 - (results.totalRes * 2)} y="-5" fill="#f59e0b" fontSize="12" textAnchor="end" fontWeight="bold" style={{textShadow: '0px 0px 4px black'}}>R ({results.totalRes.toFixed(1)}T)</text>
                                                    <line x1="20" y1="-10" x2={50 + (results.estimatedPull * 2)} y2="-10" stroke="#3b82f6" strokeWidth="4" markerEnd="url(#arrowhead-blue)" />
                                                    <text x={60 + (results.estimatedPull * 2)} y="-15" fill="#3b82f6" fontSize="12" fontWeight="bold" style={{textShadow: '0px 0px 4px black'}}>P ({results.estimatedPull.toFixed(1)}T)</text>
                                                </g>
                                            </g>

                                            <g transform="translate(0, 0)">{renderTackle}</g>

                                            <g transform="translate(250, -28)">
                                                <g transform="scale(-1, 1)">
                                                    <VehicleRenderer type={recoveryType} role="recovery" />
                                                </g>
                                            </g>
                                        </g>
                                    </g>
                                </svg>
                            </div>

                            <div className="bg-slate-900 border-t border-slate-800 p-4 grid grid-cols-2 md:grid-cols-4 gap-4 z-10">
                                <div className="flex flex-col group relative">
                                    <span className="text-xs text-slate-500 uppercase cursor-help border-b border-dashed border-slate-700 w-max">Total Resistance</span>
                                    <span className="text-xl font-bold text-white">{results.totalRes.toFixed(2)} T</span>
                                    <div className="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-slate-800 p-2 text-[10px] text-slate-300 rounded shadow-xl border border-slate-600">
                                        Sum of Rolling, Gradient, Damage, and Misc resistances.
                                    </div>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-xs text-slate-500 uppercase">Rolling Res.</span>
                                    <span className="text-lg font-medium text-slate-300">{results.rollingRes.toFixed(2)} T</span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-xs text-slate-500 uppercase">Gradient Res.</span>
                                    <span className="text-lg font-medium text-slate-300">{results.gradientRes.toFixed(2)} T</span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-xs text-slate-500 uppercase">Damage/Misc</span>
                                    <span className="text-lg font-medium text-slate-300">{(dmgVal + addVal).toFixed(2)} T</span>
                                </div>
                            </div>
                        </div>

                        {/* Right Panel: Results */}
                        <aside className="w-full lg:w-80 bg-slate-800 border-l border-slate-700 p-6 shadow-2xl z-20 flex flex-col">
                            <h2 className="text-lg font-bold text-white mb-6 border-b border-slate-600 pb-2 flex items-center gap-2">
                                <ActivityIcon className="w-5 h-5 text-indigo-400" /> Analysis
                            </h2>

                            <div className="flex-1 space-y-6">
                                <div className={`p-5 rounded-xl border transition-colors duration-300 ${results.isFeasible ? 'bg-slate-700/50 border-slate-600' : 'bg-red-900/20 border-red-500/50'}`}>
                                    <div className="text-xs uppercase tracking-wider text-slate-400 mb-1">Required Tackle</div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-4xl font-black text-white">{results.ma} : 1</span>
                                        <span className="text-sm text-slate-400">Ratio</span>
                                    </div>
                                    {!results.isFeasible && (
                                        <div className="mt-3 flex items-start gap-2 text-red-400 text-xs bg-red-950/50 p-2 rounded animate-pulse">
                                            <AlertTriangleIcon className="w-4 h-4 shrink-0 mt-0.5" />
                                            <span>Warning: Force exceeds safe operational limits (Max 12:1 simulated).</span>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-center p-3 bg-slate-900 rounded-lg">
                                        <span className="text-sm text-slate-400">Est. Winch Pull</span>
                                        <span className={`font-mono font-bold ${results.isFeasible ? 'text-indigo-400' : 'text-red-400'}`}>{results.estimatedPull.toFixed(2)} T</span>
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-slate-900 rounded-lg">
                                        <span className="text-sm text-slate-400">Winch Capacity</span>
                                        <span className="font-mono text-slate-200">{recoveryPull} T</span>
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-slate-900 rounded-lg">
                                        <span className="text-sm text-slate-400">Friction Loss</span>
                                        <span className="font-mono text-orange-400">+{results.frictionLoss.toFixed(2)} T</span>
                                    </div>
                                </div>

                                <div className="mt-8">
                                    <h3 className="text-xs uppercase text-slate-500 font-semibold mb-3">Layout Guide</h3>
                                    <div className="bg-slate-900 p-4 rounded-lg border border-slate-700 text-sm text-slate-300 leading-relaxed transition-all">
                                        {results.ma === 1 ? (
                                            <p>Direct Pull. Connect winch line directly to casualty tow points.</p>
                                        ) : (
                                            <ul className="space-y-2">
                                                <li className="flex gap-2"><ChevronsRightIcon className="w-4 h-4 text-indigo-500 shrink-0" /><span>Deploy <strong>{Math.floor(results.ma/2)}</strong> pulley(s) at Casualty.</span></li>
                                                <li className="flex gap-2"><ChevronsRightIcon className="w-4 h-4 text-indigo-500 shrink-0" /><span>Deploy <strong>{Math.floor((results.ma-1)/2)}</strong> pulley(s) at Anchor/Wrecker.</span></li>
                                                <li className="flex gap-2"><AnchorIcon className="w-4 h-4 text-indigo-500 shrink-0" /><span>Terminator point: <strong>{results.ma % 2 === 0 ? 'Recovery Vehicle' : 'Casualty Vehicle'}</strong>.</span></li>
                                            </ul>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </main>

                    {/* Equations Modal */}
                    {showEquations && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowEquations(false)}>
                            <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-2xl w-full p-6 text-slate-100 relative" onClick={e => e.stopPropagation()}>
                                <button className="absolute top-4 right-4 text-slate-400 hover:text-white" onClick={() => setShowEquations(false)}><XIcon className="w-5 h-5" /></button>
                                <h3 className="text-xl font-bold mb-6 flex items-center gap-2 text-white"><SigmaIcon className="w-5 h-5 text-indigo-400" /> Governing Equations</h3>
                                <div className="space-y-6 font-serif">
                                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <h4 className="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wide">Rolling Resistance</h4>
                                        <MathEq left="R_roll" num={<span>W &middot; cos(θ) &middot; C<sub>rr</sub></span>} den={null} />
                                        <p className="text-sm text-slate-300 leading-relaxed mt-2 text-justify">
                                            This equation calculates the force required to overcome the friction of the wheels sinking into the ground. 
                                            <strong> W</strong> represents the vehicle's total weight. The <strong>cos(θ)</strong> term reduces the normal force as the slope increases (less weight pushes "into" the ground on a steep hill). 
                                            <strong> C<sub>rr</sub></strong> is the surface coefficient (e.g., mud has a higher coefficient than concrete).
                                        </p>
                                    </div>
                                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <h4 className="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wide">Gradient Resistance</h4>
                                        <MathEq left="R_grad" num={<span>W &middot; sin(θ)</span>} den={null} />
                                        <p className="text-sm text-slate-300 leading-relaxed mt-2 text-justify">
                                            This calculates the component of gravity acting parallel to the slope. It represents the "weight" pulling the vehicle downhill. 
                                            As the angle <strong>θ</strong> increases, the sine component increases, requiring more force to pull the vehicle up.
                                        </p>
                                    </div>
                                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <h4 className="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wide">Total Estimated Winch Pull</h4>
                                        <MathEq left="P" num={<span>R<sub>total</sub> &middot; (1 + 0.1 &middot; (MA-1))</span>} den={<span>MA</span>} />
                                        <p className="text-sm text-slate-300 leading-relaxed mt-2 text-justify">
                                            This determines the actual tension required on the winch cable. 
                                            <strong> R<sub>total</sub></strong> is the sum of rolling, gradient, and damage resistances.
                                            The term <strong>0.1 &middot; (MA-1)</strong> adds 10% friction for every pulley (sheave) in the system. 
                                            Finally, we divide by the <strong>MA</strong> (Mechanical Advantage) to find the single-line pull.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Print Report */}
                    <div className="print-only bg-white text-black p-8 max-w-4xl mx-auto font-serif">
                        <div className="border-b-2 border-black pb-4 mb-6 flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl font-bold uppercase tracking-tight">Recovery Analysis Report</h1>
                                <p className="text-sm text-gray-600 mt-1">Standard Calculation Output</p>
                            </div>
                            <div className="text-right">
                                <p className="text-sm font-bold">Date: {new Date().toLocaleDateString()}</p>
                                <p className="text-xs text-gray-500">ID: {Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-8 mb-8">
                            <div>
                                <h3 className="text-sm font-bold uppercase border-b border-gray-300 mb-3 pb-1">Operational Parameters</h3>
                                <table className="w-full text-sm">
                                    <tbody>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Casualty Vehicle</td><td className="py-1 font-semibold text-right">{CASUALTIES.find(c => c.id === casualtyId)?.name}</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Casualty Weight</td><td className="py-1 font-semibold text-right">{casualtyWeight} Tons</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Surface Type</td><td className="py-1 font-semibold text-right">{SURFACES.find(s => s.value === groundCoeff)?.label}</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Gradient</td><td className="py-1 font-semibold text-right">{gradient}°</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Damage Resistance</td><td className="py-1 font-semibold text-right">{damageRes} Tons</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <h3 className="text-sm font-bold uppercase border-b border-gray-300 mb-3 pb-1">Calculation Results</h3>
                                <table className="w-full text-sm">
                                    <tbody>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Rolling Resistance</td><td className="py-1 font-mono text-right">{results.rollingRes.toFixed(2)} T</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Gradient Resistance</td><td className="py-1 font-mono text-right">{results.gradientRes.toFixed(2)} T</td></tr>
                                        <tr className="border-b border-gray-100 bg-gray-50"><td className="py-1 font-bold">Total Resistance</td><td className="py-1 font-bold font-mono text-right">{results.totalRes.toFixed(2)} T</td></tr>
                                        <tr className="border-b border-gray-100"><td className="py-1 text-gray-600">Required Ratio</td><td className="py-1 font-bold text-right">{results.ma} : 1</td></tr>
                                        <tr className="border-b border-gray-100 bg-gray-100"><td className="py-1 font-bold">Estimated Winch Pull</td><td className="py-1 font-bold font-mono text-right">{results.estimatedPull.toFixed(2)} T</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="mb-8">
                            <h3 className="text-sm font-bold uppercase border-b border-gray-300 mb-3 pb-1">Tackle Layout Configuration</h3>
                            <div className="border border-gray-200 p-4 rounded text-sm bg-gray-50">
                                <p className="mb-2"><strong>Required Mechanical Advantage: {results.ma}:1</strong></p>
                                {results.ma === 1 ? (
                                    <p>Direct pull configuration. No mechanical advantage required.</p>
                                ) : (
                                    <ul className="list-disc list-inside space-y-1 text-gray-700">
                                        <li>Install <strong>{Math.floor(results.ma/2)}</strong> snatch block(s) at the casualty vehicle.</li>
                                        <li>Install <strong>{Math.floor((results.ma-1)/2)}</strong> snatch block(s) at the anchor/recovery vehicle.</li>
                                        <li>Terminate the winch line at the <strong>{results.ma % 2 === 0 ? 'Recovery Vehicle' : 'Casualty Vehicle'}</strong>.</li>
                                    </ul>
                                )}
                            </div>
                        </div>
                        <div className="mb-8">
                            <h3 className="text-sm font-bold uppercase border-b border-gray-300 mb-3 pb-1">Mathematical Validation</h3>
                            <div className="grid grid-cols-2 gap-4 text-xs font-mono text-gray-600">
                                <div className="bg-gray-50 p-2 border">R_roll = {casualtyWeight} * cos({gradient}) * {groundCoeff} ≈ {results.rollingRes.toFixed(2)}</div>
                                <div className="bg-gray-50 p-2 border">R_grad = {casualtyWeight} * sin({gradient}) ≈ {results.gradientRes.toFixed(2)}</div>
                                <div className="col-span-2 bg-gray-50 p-2 border">P_winch = ({results.totalRes.toFixed(2)} * (1 + 0.1*{(results.ma-1)})) / {results.ma} ≈ {results.estimatedPull.toFixed(2)}</div>
                            </div>
                        </div>
                        <div className="text-xs text-gray-500 border-t pt-4 text-center">
                            <p>Validate all rigging before operation.</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RecoveryApp />);
    </script>
</body>
</html>