<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumbar Spine Analysis Toolkit | Research Dashboard</title>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- MathJax for rigorous equation rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Range Slider Styling (Light Mode) */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #0284c7; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        
        /* Grid Background for Canvas */
        .grid-bg {
            background-size: 20px 20px;
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }
    </style>
</head>
<body class="overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICON SYSTEM FIX ---
        const createIcon = (name) => {
            const iconData = lucide.icons[name];
            if (!iconData) return (props) => null;

            return ({ size = 24, className, ...props }) => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map(([tag, attrs], index) => 
                        React.createElement(tag, { ...attrs, key: index })
                    )}
                </svg>
            );
        };

        const LayoutDashboard = createIcon('LayoutDashboard');
        const Activity = createIcon('Activity');
        const Ruler = createIcon('Ruler');
        const Layers = createIcon('Layers');
        const FileText = createIcon('FileText');
        const ChevronRight = createIcon('ChevronRight');
        const AlertTriangle = createIcon('AlertTriangle');
        const CheckCircle = createIcon('CheckCircle');
        const Info = createIcon('Info');
        const Maximize2 = createIcon('Maximize2');
        const Calculator = createIcon('Calculator');
        const Brain = createIcon('Brain');
        const ZoomInIcon = createIcon('ZoomIn');
        const ZoomOutIcon = createIcon('ZoomOut');
        const RotateCcwIcon = createIcon('RotateCcw');

        const Icon = ({ name, size = 20, className }) => {
            const Component = createIcon(name);
            return <Component size={size} className={className} />;
        };

        // --- DATA CONSTANTS (From Paper) ---
        const PAPER_METRICS = {
            segmentation: {
                iou: 0.86,
                dsc: 0.97,
                mpa: 99.12
            },
            accuracy: {
                spondylolisthesis: 89,
                lordosis: 93
            }
        };

        // --- COMPONENTS ---

        // 1. SIDEBAR (Light Mode)
        const Sidebar = ({ activeTab, setActiveTab }) => {
            const menu = [
                { id: 'segmentation', label: 'Segmentation Tool', icon: 'Layers' },
                { id: 'measurements', label: 'Spinal Measurements', icon: 'Ruler' },
                { id: 'lordosis', label: 'Lordosis & Spondylo', icon: 'Activity' },
                { id: 'calculator', label: 'LSA Calculator', icon: 'Calculator' },
            ];

            return (
                <div className="w-64 bg-white border-r border-slate-200 flex flex-col h-screen shadow-sm z-20">
                    <div className="p-6 border-b border-slate-100">
                        <div className="flex items-center gap-2 text-slate-800 font-bold tracking-tight">
                            <Brain size={24} className="text-blue-600" />
                            <span>LUMBAR<span className="text-blue-600">SPINE</span> AI</span>
                        </div>
                    </div>
                    
                    <nav className="flex-1 p-4 space-y-2">
                        {menu.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 text-sm font-medium ${
                                    activeTab === item.id 
                                    ? 'bg-blue-50 text-blue-700 border border-blue-100 shadow-sm' 
                                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                }`}
                            >
                                <Icon name={item.icon} size={18} />
                                {item.label}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-100">
                        <div className="bg-slate-50 rounded p-3 text-xs text-slate-500 border border-slate-200">
                            Based on Masood et al. (2022) <br/>
                            BSPC Vol 71, 103230
                        </div>
                    </div>
                </div>
            );
        };

        // 2. SEGMENTATION TOOL (Comparison)
        const SegmentationTool = () => {
            const [sliderVal, setSliderVal] = useState(50);
            
            return (
                <div className="p-10 h-full flex flex-col max-w-6xl mx-auto">
                    <header className="mb-6 flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-900 mb-2">Segmentation Logic Comparator</h2>
                            <p className="text-slate-500 text-sm">Comparing Conventional Morphological Processing (VBSeg) vs. ResNet-UNet Deep Learning.</p>
                        </div>
                        <div className="flex gap-4 text-xs font-mono">
                            <div className="text-red-600 flex items-center gap-1">● Conventional (VBSeg)</div>
                            <div className="text-emerald-600 flex items-center gap-1">● ResNet-UNet (Proposed)</div>
                        </div>
                    </header>

                    <div className="flex-1 bg-slate-900 rounded-xl border border-slate-300 relative overflow-hidden group min-h-[500px] shadow-md">
                        {/* Simulated Image Content */}
                        <div className="absolute inset-0 flex items-center justify-center bg-black">
                            {/* Base MRI Simulation */}
                            <svg viewBox="0 0 400 600" className="h-full w-full opacity-60">
                                <filter id="noise">
                                    <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/>
                                </filter>
                                <rect width="100%" height="100%" filter="url(#noise)" opacity="0.3"/>
                                {/* Spinal Column */}
                                {[0, 1, 2, 3, 4].map(i => (
                                    <rect key={i} x="160" y={100 + i*90} width="80" height="60" rx="5" fill="#e2e8f0" opacity="0.9" />
                                ))}
                                <path d="M160 550 C 200 580, 200 580, 240 550 L 220 600 L 180 600 Z" fill="#e2e8f0" opacity="0.9"/>
                            </svg>
                        </div>

                        {/* Overlay: Conventional (Left) */}
                        <div 
                            className="absolute inset-0 bg-black/80 z-10 overflow-hidden border-r-2 border-white/80"
                            style={{ width: `${sliderVal}%` }}
                        >
                            <div className="absolute inset-0 flex items-center justify-center w-full h-full">
                                <div className="absolute top-4 left-4 bg-red-900/80 text-red-100 px-3 py-1 rounded text-xs font-bold border border-red-500/50 backdrop-blur-sm">
                                    Conventional VBSeg
                                </div>
                                <svg viewBox="0 0 400 600" className="h-full w-full absolute top-0 left-0">
                                    {/* VBSeg often misses edges or merges regions - simulate this */}
                                    <rect x="165" y="105" width="70" height="50" rx="2" fill="none" stroke="#f87171" strokeWidth="2" />
                                    <rect x="162" y="195" width="75" height="55" rx="2" fill="none" stroke="#f87171" strokeWidth="2" />
                                    {/* Missed L3/Merged */}
                                    <path d="M160 280 L240 280 L240 430 L160 430 Z" fill="none" stroke="#f87171" strokeWidth="2" strokeDasharray="4 4" />
                                    <text x="250" y="360" fill="#f87171" fontSize="20" fontFamily="monospace">Region Merger Error</text>
                                </svg>
                            </div>
                        </div>

                        {/* Overlay: Deep Learning (Right) */}
                        <div className="absolute inset-0 z-0">
                            <div className="absolute top-4 right-4 bg-emerald-900/80 text-emerald-100 px-3 py-1 rounded text-xs font-bold border border-emerald-500/50 backdrop-blur-sm">
                                ResNet-UNet (DSC 0.97)
                            </div>
                            <svg viewBox="0 0 400 600" className="h-full w-full absolute top-0 left-0">
                                {/* DL Masks are precise */}
                                {[0, 1, 2, 3, 4].map(i => (
                                    <rect key={i} x="160" y={100 + i*90} width="80" height="60" rx="5" fill="#10b981" opacity="0.3" stroke="#10b981" strokeWidth="2" />
                                ))}
                                <path d="M160 550 C 200 580, 200 580, 240 550 L 220 600 L 180 600 Z" fill="#10b981" opacity="0.3" stroke="#10b981" strokeWidth="2"/>
                            </svg>
                        </div>

                        {/* Slider Handle */}
                        <input 
                            type="range" min="0" max="100" value={sliderVal} 
                            onChange={(e) => setSliderVal(e.target.value)}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-30"
                        />
                        <div 
                            className="absolute top-0 bottom-0 w-1 bg-white cursor-ew-resize z-20 pointer-events-none shadow-[0_0_15px_rgba(0,0,0,0.5)]"
                            style={{ left: `${sliderVal}%` }}
                        >
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg border border-slate-200">
                                <div className="flex gap-0.5">
                                    <div className="w-0.5 h-3 bg-slate-400"></div>
                                    <div className="w-0.5 h-3 bg-slate-400"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 grid grid-cols-3 gap-4 text-center">
                        <div className="bg-white p-3 rounded border border-slate-200 shadow-sm">
                            <div className="text-slate-500 text-xs uppercase tracking-wide">Preprocessing</div>
                            <div className="text-slate-900 font-mono text-sm mt-1">CLAHE + Unsharp Mask</div>
                        </div>
                        <div className="bg-white p-3 rounded border border-slate-200 shadow-sm">
                            <div className="text-slate-500 text-xs uppercase tracking-wide">Loss Function</div>
                            <div className="text-slate-900 font-mono text-sm mt-1">Cross-Entropy</div>
                        </div>
                        <div className="bg-white p-3 rounded border border-slate-200 shadow-sm">
                            <div className="text-slate-500 text-xs uppercase tracking-wide">Optimizer</div>
                            <div className="text-slate-900 font-mono text-sm mt-1">Adadelta (Batch=2)</div>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. INTERACTIVE SPINAL MEASUREMENTS TOOL
        const MeasurementsTool = () => {
            // Initial Centroid Positions (L1 to S1)
            const initialCentroids = [
                { x: 180, y: 100, label: 'L1' },
                { x: 195, y: 180, label: 'L2' },
                { x: 215, y: 260, label: 'L3' },
                { x: 210, y: 340, label: 'L4' },
                { x: 185, y: 420, label: 'L5' },
                { x: 150, y: 490, label: 'S1' },
            ];

            const [centroids, setCentroids] = useState(initialCentroids);
            const [dragging, setDragging] = useState(null);
            const svgRef = useRef(null);

            // Calculations based on Paper
            const metrics = useMemo(() => {
                // LLA (Simplified angle between L1 and S1 slope approximation)
                const l1 = centroids[0];
                const s1 = centroids[5];
                const dy = s1.y - l1.y;
                const dx = s1.x - l1.x;
                const lla = Math.abs(Math.atan2(dx, dy) * (180 / Math.PI) * 2).toFixed(1); 

                // LSA (L5 vs S1)
                const l5 = centroids[4];
                const lsa = Math.abs((Math.atan2(l5.x - s1.x, l5.y - s1.y) * 180/Math.PI)).toFixed(1);

                // Lumbar Height (Centroid Method)
                const lh = Math.sqrt(Math.pow(s1.x - l1.x, 2) + Math.pow(s1.y - l1.y, 2)).toFixed(1);

                return { lla, lsa, lh };
            }, [centroids]);

            const handleMouseDown = (index) => (e) => {
                setDragging(index);
            };

            const handleMouseMove = (e) => {
                if (dragging === null) return;
                const svgRect = svgRef.current.getBoundingClientRect();
                const x = e.clientX - svgRect.left;
                const y = e.clientY - svgRect.top;
                
                const newCentroids = [...centroids];
                newCentroids[dragging] = { ...newCentroids[dragging], x, y };
                setCentroids(newCentroids);
            };

            const handleMouseUp = () => setDragging(null);

            return (
                <div className="flex flex-col md:flex-row h-full p-10 gap-8 max-w-7xl mx-auto" onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    
                    {/* Left: Interactive Canvas (Dark Mode for Image) */}
                    <div className="flex-1 bg-slate-900 rounded-xl border border-slate-300 shadow-md relative overflow-hidden min-h-[600px]">
                        <div className="absolute top-4 left-4 z-10 pointer-events-none">
                            <h3 className="text-white font-bold bg-black/50 px-3 py-1.5 rounded backdrop-blur-sm border border-white/10">Interactive Centroid Model</h3>
                            <p className="text-xs text-slate-300 mt-1 pl-1">Drag the centroids to simulate deformity.</p>
                        </div>
                        
                        <div className="absolute top-4 right-4 z-10">
                            <div className="flex flex-col gap-2">
                                <button className="p-2 bg-slate-800 text-slate-200 rounded hover:bg-slate-700 border border-slate-600"><ZoomInIcon size={16} /></button>
                                <button className="p-2 bg-slate-800 text-slate-200 rounded hover:bg-slate-700 border border-slate-600"><ZoomOutIcon size={16} /></button>
                                <button className="p-2 bg-slate-800 text-slate-200 rounded hover:bg-slate-700 border border-slate-600"><RotateCcwIcon size={16} /></button>
                            </div>
                        </div>

                        <svg 
                            ref={svgRef}
                            className="w-full h-full cursor-crosshair grid-bg"
                            onMouseMove={handleMouseMove}
                        >
                            {/* Curve Interpolation */}
                            <path 
                                d={`M ${centroids.map(c => `${c.x},${c.y}`).join(' L ')}`}
                                fill="none" 
                                stroke="#3b82f6" 
                                strokeWidth="2" 
                                strokeDasharray="5 5"
                                opacity="0.6"
                            />
                            
                            {/* Connecting Line for AUC Area Closure */}
                            <line 
                                x1={centroids[0].x} y1={centroids[0].y}
                                x2={centroids[5].x} y2={centroids[5].y}
                                stroke="#10b981" strokeWidth="1" strokeDasharray="2 2"
                            />

                            {/* Vertebrae Visualization */}
                            {centroids.map((c, i) => (
                                <g key={i} onMouseDown={handleMouseDown(i)} className="cursor-grab hover:opacity-80">
                                    {/* Bone Shape Approximation */}
                                    <rect 
                                        x={c.x - 30} y={c.y - 20} 
                                        width="60" height="40" 
                                        rx="4" 
                                        fill={i === 5 ? "#94a3b8" : "#cbd5e1"} 
                                        opacity="0.3"
                                        stroke="white"
                                        strokeWidth="1"
                                    />
                                    {/* Centroid Point */}
                                    <circle cx={c.x} cy={c.y} r="6" fill="#38bdf8" stroke="white" strokeWidth="2" />
                                    <text x={c.x + 35} y={c.y + 5} fill="white" fontSize="12" className="font-mono font-bold drop-shadow-md">{c.label}</text>
                                </g>
                            ))}
                        </svg>
                    </div>

                    {/* Right: Real-time Analysis Panel (Light Mode) */}
                    <div className="w-full md:w-80 flex flex-col gap-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h4 className="text-xs uppercase tracking-wide text-slate-500 mb-4 border-b border-slate-100 pb-2 font-bold">Quantitative Metrics</h4>
                            
                            <div className="space-y-6">
                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-slate-700">Lumbar Lordosis (LLA)</span>
                                        <span className="text-xl font-bold text-blue-600">{metrics.lla}°</span>
                                    </div>
                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-500 transition-all duration-300" style={{width: `${Math.min(metrics.lla, 100)}%`}}></div>
                                    </div>
                                    <p className="text-[10px] text-slate-400 mt-1">Ref Range: 39° - 53°</p>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-slate-700">Lumbosacral (LSA)</span>
                                        <span className="text-xl font-bold text-purple-600">{metrics.lsa}°</span>
                                    </div>
                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-purple-500 transition-all duration-300" style={{width: `${Math.min(metrics.lsa * 2, 100)}%`}}></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-sm font-medium text-slate-700">Lumbar Height</span>
                                        <span className="text-xl font-bold text-emerald-600">{metrics.lh} <span className="text-xs text-slate-400 font-normal">px</span></span>
                                    </div>
                                    <p className="text-[10px] text-slate-400">Method: Euclidean Dist (L1-S1)</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex-1">
                            <h4 className="text-xs uppercase tracking-wide text-slate-500 mb-4 border-b border-slate-100 pb-2 font-bold">Analysis Equations</h4>
                            <div className="space-y-4">
                                <div className="bg-slate-50 p-3 rounded text-center border border-slate-100">
                                    <span className="text-xs text-slate-500 block mb-1">Lumbar Height</span>
                                    <code className="text-emerald-700 text-xs">d = √[(x₂-x₁)² + (y₂-y₁)²]</code>
                                </div>
                                <div className="bg-slate-50 p-3 rounded text-center border border-slate-100">
                                    <span className="text-xs text-slate-500 block mb-1">Cobb Angle (Approx)</span>
                                    <code className="text-blue-700 text-xs">θ = |m₁ - m₂|</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. DISEASE CLASSIFICATION TOOL
        const ClassificationTool = () => {
            const [angles, setAngles] = useState({ L1: 10, L2: 12, L3: 45, L4: 15, L5: 14 }); // L3 outlier simulates spondylo
            const [area, setArea] = useState(4500); // AUC simulation

            const spondyloResult = useMemo(() => {
                const vals = Object.values(angles);
                const mean = vals.reduce((a,b) => a+b, 0) / vals.length;
                const std = Math.sqrt(vals.map(x => Math.pow(x - mean, 2)).reduce((a,b) => a+b) / vals.length);
                const threshold = mean + std;
                const thresholdMin = mean - std;

                const outliers = [];
                Object.entries(angles).forEach(([k, v]) => {
                    if (v > threshold) outliers.push({ vb: k, type: 'Anterior', val: v });
                    else if (v < thresholdMin) outliers.push({ vb: k, type: 'Posterior', val: v });
                });

                return { mean: mean.toFixed(1), std: std.toFixed(1), outliers };
            }, [angles]);

            const lordosisResult = useMemo(() => {
                const NORMAL_RANGE_MIN = 4000;
                const NORMAL_RANGE_MAX = 5500;
                
                if (area > NORMAL_RANGE_MAX) return { label: 'Hyper-Lordosis (Sway Back)', color: 'text-orange-600' };
                if (area < NORMAL_RANGE_MIN) return { label: 'Hypo-Lordosis (Flat Back)', color: 'text-blue-600' };
                return { label: 'Normal Lordosis', color: 'text-emerald-600' };
            }, [area]);

            return (
                <div className="p-10 max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <header>
                        <h2 className="text-2xl font-bold text-slate-900 mb-2">Automated Disease Classification</h2>
                        <p className="text-slate-600 text-sm">Implementation of Algorithm 3 (Spondylolisthesis) and Algorithm 4 (Lordosis AUC) from the paper.</p>
                    </header>

                    {/* SPONDYLOLISTHESIS SECTION */}
                    <div className="bg-white rounded-xl border border-slate-200 p-8 shadow-sm">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-semibold text-slate-800 flex items-center gap-2"><AlertTriangle size={20} className="text-yellow-500"/> Spondylolisthesis Detector</h3>
                            <div className="text-xs bg-slate-100 px-3 py-1 rounded text-slate-600 font-medium">Method: Angular Deviation</div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <p className="text-xs text-slate-500 mb-4">Adjust angular deviation for each vertebral level to test the algorithm:</p>
                                {Object.entries(angles).map(([key, val]) => (
                                    <div key={key} className="flex items-center gap-4">
                                        <span className="w-8 text-sm font-bold text-slate-700">{key}</span>
                                        <input 
                                            type="range" min="0" max="60" value={val}
                                            onChange={(e) => setAngles({...angles, [key]: parseInt(e.target.value)})}
                                            className="flex-1"
                                        />
                                        <span className="w-8 text-xs font-mono text-slate-500">{val}°</span>
                                    </div>
                                ))}
                            </div>

                            <div className="bg-slate-50 rounded-lg p-6 border border-slate-200 flex flex-col justify-center">
                                <div className="flex justify-between text-xs text-slate-600 mb-2 font-mono font-medium">
                                    <span>θ_mean: {spondyloResult.mean}</span>
                                    <span>σ_theta: {spondyloResult.std}</span>
                                </div>
                                <div className="border-t border-slate-200 my-3"></div>
                                
                                {spondyloResult.outliers.length === 0 ? (
                                    <div className="flex items-center gap-2 text-emerald-600 font-bold mt-2">
                                        <CheckCircle size={24} /> No Dislocation Detected
                                    </div>
                                ) : (
                                    <div className="space-y-2 mt-2">
                                        {spondyloResult.outliers.map((o, i) => (
                                            <div key={i} className="flex items-center gap-2 text-red-600 font-bold bg-red-50 p-2 rounded border border-red-200">
                                                <AlertTriangle size={20} />
                                                <span>{o.type} Spondylolisthesis at {o.vb}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <p className="text-[10px] text-slate-400 mt-4 italic">
                                    Logic: If θ_i {'>'} (θ_mean + σ), mark as Anterior.
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* LORDOSIS SECTION */}
                    <div className="bg-white rounded-xl border border-slate-200 p-8 shadow-sm">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-semibold text-slate-800 flex items-center gap-2"><Activity size={20} className="text-blue-500"/> Lordosis Assessment (AUC)</h3>
                            <div className="text-xs bg-slate-100 px-3 py-1 rounded text-slate-600 font-medium">Method: Area Under Curve</div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div>
                                <label className="text-xs text-slate-500 block mb-2">Enclosed Area Region (A_r):</label>
                                <input 
                                    type="range" min="2000" max="8000" step="100" value={area}
                                    onChange={(e) => setArea(parseInt(e.target.value))}
                                    className="w-full mb-2"
                                />
                                <div className="flex justify-between text-[10px] text-slate-400 font-mono">
                                    <span>Flat Back (Hypo)</span>
                                    <span>Normal</span>
                                    <span>Sway Back (Hyper)</span>
                                </div>
                            </div>

                            <div className="bg-slate-50 rounded-lg p-6 border border-slate-200 text-center">
                                <span className="text-slate-400 text-xs uppercase tracking-widest font-bold">Classification</span>
                                <div className={`text-2xl font-bold mt-2 ${lordosisResult.color}`}>
                                    {lordosisResult.label}
                                </div>
                                <div className="mt-4 font-mono text-xs text-slate-500">
                                    Calculated Area: {area} units
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. LSA CALCULATOR
        const CalculatorTool = () => {
            const [m_l5, setML5] = useState(1.2);
            const [m_s1, setMS1] = useState(0.5);
            
            const lsa = useMemo(() => {
                const thetaL5 = Math.atan(m_l5);
                const thetaS1 = Math.atan(m_s1);
                const diff = Math.abs(thetaL5 - thetaS1);
                return (diff * (180 / Math.PI)).toFixed(2);
            }, [m_l5, m_s1]);

            return (
                <div className="p-10 max-w-5xl mx-auto animate-fade-in h-full flex flex-col justify-center">
                    <div className="bg-white rounded-xl border border-slate-200 p-10 shadow-lg">
                        <header className="mb-8 border-b border-slate-100 pb-4">
                            <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3">
                                <Icon name="Calculator" className="text-purple-600" /> 
                                Lumbosacral Angle (LSA) Calculator
                            </h2>
                            <p className="text-slate-500 text-sm mt-1">Based on Eq. 5: θ = | tan⁻¹(m_L5) - tan⁻¹(m_S1) |</p>
                        </header>

                        <div className="grid grid-cols-2 gap-12">
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm text-slate-600 mb-2 font-medium">Slope of L5 Inferior Endplate (m_L5)</label>
                                    <input 
                                        type="number" step="0.1" value={m_l5}
                                        onChange={(e) => setML5(parseFloat(e.target.value))}
                                        className="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-900 focus:border-purple-500 outline-none font-mono"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-600 mb-2 font-medium">Slope of S1 Superior Endplate (m_S1)</label>
                                    <input 
                                        type="number" step="0.1" value={m_s1}
                                        onChange={(e) => setMS1(parseFloat(e.target.value))}
                                        className="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-900 focus:border-purple-500 outline-none font-mono"
                                    />
                                </div>
                            </div>

                            <div className="flex flex-col justify-center items-center bg-slate-50 rounded-xl border border-slate-200 p-6 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-blue-500"></div>
                                <span className="text-slate-400 text-xs uppercase tracking-widest mb-2 font-bold">Calculated LSA</span>
                                <span className="text-5xl font-bold text-slate-900 tracking-tight">{lsa}°</span>
                                
                                {/* Visual Representation of Slopes */}
                                <div className="mt-6 w-32 h-32 border border-slate-200 rounded-full relative bg-white shadow-inner">
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        {/* L5 Line */}
                                        <div 
                                            className="absolute w-24 h-1 bg-blue-500 rounded" 
                                            style={{ transform: `rotate(${-Math.atan(m_l5) * 180 / Math.PI}deg)` }}
                                        ></div>
                                        {/* S1 Line */}
                                        <div 
                                            className="absolute w-24 h-1 bg-emerald-500 rounded" 
                                            style={{ transform: `rotate(${-Math.atan(m_s1) * 180 / Math.PI}deg)` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN LAYOUT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('segmentation');

            return (
                <div className="flex h-screen bg-slate-50 text-slate-900 font-sans">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    
                    <main className="flex-1 overflow-auto bg-[#f8fafc] relative">
                        {/* Background Grid Pattern */}
                        <div className="absolute inset-0 grid-bg opacity-40 pointer-events-none"></div>
                        
                        <div className="relative z-10 h-full">
                            {activeTab === 'segmentation' && <SegmentationTool />}
                            {activeTab === 'measurements' && <MeasurementsTool />}
                            {activeTab === 'lordosis' && <ClassificationTool />}
                            {activeTab === 'calculator' && <CalculatorTool />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>